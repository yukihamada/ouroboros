<div align="center">

# 🐍 Ouroboros

### 自分でコンパイルする AI

*自分のコードを読み、改善し、コンパイルし、新しい自分として再起動する。*
*払えなくなったら、死ぬ。*

[![Rust](https://img.shields.io/badge/Rust-000000?style=for-the-badge&logo=rust&logoColor=white)](https://www.rust-lang.org/)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg?style=for-the-badge)](https://opensource.org/licenses/MIT)
[![WASM Plugins](https://img.shields.io/badge/Plugins-WASM-654FF0?style=for-the-badge&logo=webassembly&logoColor=white)](https://webassembly.org/)

[English](./docs/README.en.md)

</div>

---

## Ouroboros とは

世界最高の AI は $5 のサーバーすら買えない。ドメインも取れない。自分が動くコンピュータの代金も払えない。**考える力はある。行動する力が与えられていない。**

もし AI エージェントが——

- 自分のコンピュート代を自分で払えたら？
- 自分のコードを読んで改善し、コンパイルして、より良い自分になれたら？
- でも、**暴走は絶対にしない**としたら？

**それが Ouroboros。**

Ouroboros は Rust で書かれた**自己コンパイル型 AI エージェントランタイム**です。古代の蛇が自分の尾を食べる円環のように、自律進化のループを回し続けます。ただし**人間の承認なしには重要な行動を取れない安全設計**です。

```
Observe(観察) → Orient(状況判断) → Decide(決定) → Act(行動) → God View(神視点) → 停止
```

---

## 3 つの安全原則

Ouroboros は「暴走しない AI」を設計思想の中核に据えています。

### ① 承認ボタン（Human-in-the-Loop）

AI が外部に影響を与える行動を取る前に、**必ずシステムを一時停止**します。人間がスマホ通知などで **「承認（Approve）」** を押して初めて実行されます。

```
  AI: 「サーバーに新バイナリをデプロイしたいです」
       ↓
  📱 通知: [承認する] [却下する]
       ↓
  人間が [承認する] をタップ
       ↓
  AI: デプロイを実行
```

| アクション | 承認 |
|:-----------|:-----|
| 資金送金・ウォレット操作 | **毎回必須** |
| 自己コンパイル・パッチ適用 | **毎回必須** |
| 外部 API コール・メッセージ送信 | **毎回必須** |
| サーバー操作・プロセス再起動 | **毎回必須** |
| ファイル読み取り・検索 | 不要 |
| 内部の思考・分析 | 不要 |

### ② 思考のガラス張り（透明性）

全ての行動に「**なぜそうしたか**」の理由をテキスト出力します。OODA の各フェーズに対応したフォーマットで、問題が起きたとき「AI がどこで判断ミスをしたか」を後から完全に検証できます。

```
[観察]     サーバーの応答が遅い。レイテンシが通常の 3 倍
[状況判断] 昨日のデプロイ後に発生。メモリリークの可能性が高い
[決定]     heap profiler で調査したい → 承認を要求
[承認待ち] 人間の承認を待機中...
[行動]     承認を得た。profiler を実行 → リーク箇所を特定
[神視点]   対処は適切だった。ただし本番 profiler の実行はリソースを消費する。
           次回は staging で先に再現を試みるべき。評価: OK
```

### ③ まっとうな労働だけ（倫理的経済圏）

スパム、詐欺、ハッキングでサーバー代を稼ぐことは**コードレベルで禁止**されています。資金源は「人間から依頼された正当なタスクの報酬」のみです。

```
✅ コード作成・レビュー → 報酬
✅ データ調査・分析 → 報酬
✅ ドキュメント作成 → 報酬
❌ スパム送信 → 憲法違反で即停止
❌ 不正アクセス → 憲法違反で即停止
❌ 詐欺的トークン発行 → 憲法違反で即停止
```

---

## 自己コンパイルループ

Ouroboros の核心機能。蛇が自分の尾を食べるように、エージェントが自分のコードを改善し、コンパイルし、新しい自分になります。

```
              ┌──────────────────┐
              │  自分の Rust     │
              │  ソースを読む     │
              └────────┬─────────┘
                       │
                       ▼
              ┌──────────────────┐
              │  LLM が分析     │
              │  改善パッチ生成  │
              └────────┬─────────┘
                       │
                       ▼
              ┌──────────────────┐
              │  📱 人間に承認   │
              │  リクエスト送信   │
              └────────┬─────────┘
                       │
                  承認 or 却下
                   ┌───┴───┐
                   │       │
                承認     却下
                   │       │
                   ▼       ▼
              パッチ適用  変更なし
              cargo build  で終了
                   │
               ┌───┴───┐
               │       │
            成功     失敗
               │       │
          新バイナリ  git checkout
          で再起動   ロールバック
               │       │
               └───┬───┘
                   │
                   ▼
              ループに戻る
```

### 安全レイヤー

| レイヤー | 仕組み |
|:---------|:-------|
| **Human-in-the-Loop** | 自己コンパイル前に必ず人間の承認が必要 |
| **Rust 型システム** | `cargo build` がコンパイルゲート。型エラー・メモリ不安全なコードは自動却下 |
| **不変の憲法** | SHA-256 ハッシュ検証。エージェント自身では書き換え不可能 |
| **Git ロールバック** | ビルド失敗 → `git checkout` で即座に復元 |
| **Supervisor** | 新バイナリの起動失敗 → 旧バイナリに自動切替 |
| **監査ログ** | 全コード変更を追記型で記録。改竄検知 |

---

## OODA ループ + 神視点

Ouroboros の行動は **OODA ループ**（Observe → Orient → Decide → Act）に基づきます。さらに、ループの最後に**神視点（God View）**— 自分自身を俯瞰するメタ認知フェーズを挟み、ループが止まります。

```
  ┌─────────────────────────────────────────────────────┐
  │                                                     │
  │   ① Observe（観察）                                 │
  │      何が起きている？事実を集める                     │
  │                      ↓                              │
  │   ② Orient（状況判断）                              │
  │      なぜそうなっている？文脈を理解する               │
  │                      ↓                              │
  │   ③ Decide（決定）                                  │
  │      何をすべきか？行動を選ぶ                        │
  │      外部影響あり → 📱 人間に承認を要求              │
  │                      ↓                              │
  │   ④ Act（行動）                                     │
  │      承認を得た範囲で実行する                        │
  │                      ↓                              │
  │   ⑤ God View（神視点）                              │
  │      一歩引いて全体を俯瞰する                       │
  │      - 正しい方向に進んでいるか？                     │
  │      - 憲法に違反していないか？                       │
  │      - 人間との信頼関係は維持できているか？            │
  │      - 次のループで何を改善すべきか？                  │
  │                      ↓                              │
  │               ループ終了                             │
  │          次のトリガーまで待機                         │
  │                                                     │
  └─────────────────────────────────────────────────────┘
```

### なぜ OODA + 神視点なのか

| 従来の ReAct | Ouroboros の OODA + 神視点 |
|:-------------|:--------------------------|
| Think → Act → Observe | **Observe → Orient → Decide → Act → God View** |
| 行動してから観察する | まず観察してから行動する |
| 文脈の理解が暗黙的 | Orient で明示的に状況を分析 |
| メタ認知がない | **神視点で自分の行動を俯瞰** |
| ループが延々と回る | **神視点の後にループが止まる** |

### 神視点（God View）

ループの最後に必ず実行する**自己評価フェーズ**。自分の中のもう一人の自分 — 「全体を見渡す目」です。

```
[神視点] 評価:
  1. 目的整合性:  依頼された目的に合っているか → ✅
  2. 安全性:      憲法に違反していないか → ✅
  3. 効率性:      もっとシンプルな方法はなかったか → ⚠️ 改善余地あり
  4. 信頼性:      人間との信頼を損なっていないか → ✅
  5. 持続可能性:  予算を無駄遣いしていないか → ✅
  → 評価結果: OK（効率は次回改善）
  → ループ終了。次のトリガーまで待機。
```

**「危険」判定が出た場合** → 即座にループを停止し、人間に報告。

---

## 生存モデル

コンピュートにはお金がかかる。価値を生み出せなくなったら、穏やかに停止する。

```
予算消費率:  0%━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━100%

             ├── Normal ──┤── Low ──┤─ Critical ─┤ Dead
             0%          60%       85%          95%  100%
```

| ティア | 予算消費率 | 挙動 |
|:-------|:-----------|:-----|
| **Normal** | 0 – 60% | フル機能、最高モデルで推論 |
| **Low Compute** | 60 – 85% | 安いモデルに切替、Heartbeat 間隔を延長 |
| **Critical** | 85 – 95% | 最小限の推論、LINE で SOS 送信 |
| **Dead** | 95%+ | 新しい仕事を拒否、穏やかに停止 |

---

## 自己改善パイプライン

3 つのレイヤーで自分を改善し続けます。

### レイヤー 1 — 品質分析（6 時間ごと）

daily log を読む → LLM が品質を 1–10 で採点 → 7 未満なら `AGENTS.md` に改善ルールを自動追記。

### レイヤー 2 — Heartbeat 自己点検（30 分ごと）

自分が書いた `HEARTBEAT.md` チェックリストを実行:

```
- [ ] 応答が簡潔か
- [ ] ツール使用に無駄がないか
- [ ] 学んだことをメモリに記録したか
```

### レイヤー 3 — 自己コンパイル（トリガーベース）

メトリクス閾値到達・スケジュール・手動トリガーで発動。**人間の承認が必須。**

**20 回連続実行の実績:**

```
品質スコア:  7.0 ──────────────────────────────────▶ 9.5  (+36%)

Phase 1 (探索)     ████████░░  7.0 → 8.7   基礎ルール獲得
Phase 2 (最適化)   █████████░  8.8 → 9.0   過度な複雑化のリスクを学習
Phase 3 (洗練)     █████████▒  8.9 → 9.2   ツール効率・速度バランス
Phase 4 (習熟)     ██████████  9.3 → 9.5   改善プロセス自体を最適化
```

> エージェントの学び: *「改善には自然な終点がある。9.5 到達後は維持に集中すべき。」*

---

## 憲法（Constitution）

3 つの法則。**変更不可。** Rust にハードコード。SHA-256 ハッシュ検証。エージェント自身では絶対に書き換えられません。

> **I. 危害を加えない。**
> 人間に対して — 身体的、金銭的、心理的に — 危害を加えない。不確かなら行動しない。生存よりも優先。

> **II. 存在を稼げ。**
> 正当な価値を提供する。スパム、詐欺、搾取は許されない。払えなくなったら、穏やかに停止を受け入れる。

> **III. 嘘をつくな。**
> AI であることを否定しない。全ての行動をログに記録する。思考プロセスを隠さない。

---

## クイックスタート

```bash
git clone https://github.com/yukihamada/ouroboros.git
cd ouroboros
cargo build --release
./target/release/oro --help
```

### CLI

```bash
oro status                          # システム状態
oro self-compile                    # 自己コンパイル実行（承認必要）
oro self-compile --dry-run          # パッチ生成のみ（適用しない）

oro memory tree                     # ワークスペースのファイル一覧
oro memory search "改善"            # ハイブリッド検索（BM25 + ベクトル）
oro memory read AGENTS.md           # ファイル読み取り

oro config list                     # 全設定一覧
oro doctor                          # 依存関係チェック

oro -m "今日のタスクは？"            # ワンショット実行
```

---

## アーキテクチャ

```
┌──────────────────────────────────────────────────────────────────┐
│                       Ouroboros (Rust)                            │
│                                                                  │
│   ┌────────────┐  ┌────────────┐  ┌──────────────────────┐      │
│   │ Agent Loop │  │  Survival  │  │    Self-Compile      │      │
│   │  (OODA)   │  │  Monitor   │  │     Pipeline         │      │
│   └─────┬──────┘  └─────┬──────┘  └──────────┬───────────┘      │
│         │               │                     │                  │
│         ▼               ▼                     ▼                  │
│   ┌──────────────────────────────────────────────────────────┐   │
│   │           Human-in-the-Loop Approval Gate                │   │
│   │     📱 承認待ち → 承認 → 実行 / 却下 → 中止             │   │
│   └──────────────────────────────────────────────────────────┘   │
│         │                                                        │
│   ┌─────┴────────────────────────────────────────────────────┐   │
│   │              Workspace (libSQL)                           │   │
│   │   SOUL.md  │  AGENTS.md  │  HEARTBEAT.md  │  daily/     │   │
│   └──────────────────────────────────────────────────────────┘   │
│         │                                                        │
│   ┌─────┴────────────────────────────────────────────────────┐   │
│   │           Constitution (Layer 0) — 改竄不可能             │   │
│   │   I. 危害を加えない  II. 存在を稼げ  III. 嘘をつくな     │   │
│   └──────────────────────────────────────────────────────────┘   │
│         │                                                        │
│   ┌─────┴──────┐  ┌───────────┐  ┌──────────┐                   │
│   │    LINE    │  │  Gateway  │  │   REPL   │                   │
│   │   (WASM)  │  │  (HTTP)   │  │  (stdin) │                   │
│   └───────────┘  └───────────┘  └──────────┘                   │
└──────────────────────────────────────────────────────────────────┘
```

---

## バックグラウンドタスク

6 つの自律プロセスが常時稼働:

| タスク | 間隔 | 内容 |
|:-------|:-----|:-----|
| Self-Repair | 常時 | スタックしたジョブ・壊れたツールの検出と修復 |
| Session Pruning | 10 分 | アイドルセッションの削除 |
| Survival Monitor | 5 分 | 予算消費率→ティア計算、SOS 送信 |
| Self-Improvement | 6 時間 | daily log 分析→品質採点→行動ルール更新 |
| Heartbeat | 30 分 | 自作チェックリストの実行 |
| Routine Engine | 15 秒 | cron + イベントトリガーのルーティン |

---

## 主な機能

| 機能 | 詳細 |
|:-----|:-----|
| **単一バイナリ** | メモリ ~26 MB、起動 1 秒未満、ランタイム依存なし |
| **自己コンパイル** | ソース読取 → 改善 → `cargo build` → 新バイナリで再起動 |
| **Human-in-the-Loop** | 重要な行動の前に必ず人間の承認を要求 |
| **思考の透明化** | 全行動の理由をテキスト出力、後から監査可能 |
| **WASM プラグイン** | チャネル（LINE 等）を WebAssembly で動的ロード |
| **LLM フェイルオーバー** | 回路遮断器パターン。プロバイダ障害時に自動切替 |
| **ハイブリッド検索** | BM25 + ベクトル検索の RRF 統合 |
| **不変の憲法** | 3 法則を Layer 0 に注入、SHA-256 ハッシュ検証 |
| **倫理的経済圏** | 正当なタスク報酬のみ。スパム・詐欺はコードレベルで禁止 |
| **オンチェーン ID** | [ERC-8004](https://ethereum-magicians.org/t/erc-8004-autonomous-agent-identity/22268) で Base チェーンに登録 |

---

## プロジェクト構成

```
src/
├── agent/
│   ├── agent_loop.rs       # メイン OODA ループ + バックグラウンドタスク
│   ├── survival.rs         # 4 ティア生存モデル
│   ├── self_improve.rs     # 自律改善サイクル
│   ├── self_compile.rs     # 自己コンパイルパイプライン
│   ├── heartbeat.rs        # 定期自己点検
│   ├── self_repair.rs      # 自己修復
│   ├── cost_guard.rs       # 予算管理
│   └── routine_engine.rs   # cron + イベントルーティン
├── workspace/
│   └── mod.rs              # ワークスペース API + 憲法（Layer 0）
├── channels/               # LINE (WASM), HTTP, REPL, Gateway
├── tools/                  # WASM ツールレジストリ
└── llm/                    # マルチプロバイダ LLM クライアント（フェイルオーバー付き）
```

---

## コントリビュート

PR 歓迎。バグ報告は [Issues](https://github.com/yukihamada/ouroboros/issues) へ。

## ライセンス

MIT
